rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: Is the user authenticated?
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper: Get user's householdId from their user document
    function getHouseholdId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.householdId;
    }

    // Helper: Is the user a member of the requested householdId?
    function isHouseholdMember(householdId) {
      return isAuthenticated() && (
        getHouseholdId() == householdId || 
        get(/databases/$(database)/documents/households/$(householdId)).data.members.hasAny([request.auth.uid])
      );
    }

    // User documents
    match /users/{uid} {
      allow read, write: if request.auth != null && request.auth.uid == uid;
    }

    // Household documents
    match /households/{householdId} {
      allow read: if isHouseholdMember(householdId);
      allow create: if isAuthenticated();
      allow update: if isHouseholdMember(householdId); // Owners/Members can update members
    }

    // Budget data collections (Bank Accounts, Expenses, Recurring Templates, etc.)
    match /{collection}/{docId} {
      allow read, write: if collection in ['bankAccounts', 'expenses', 'recurringTemplates', 'monthlySnapshots', 'categories'] && 
                         isHouseholdMember(resource.data.householdId || request.resource.data.householdId);
    }
    
    // Exchange rates (read-only for everyone)
    match /exchangeRates/{id} {
      allow read: if true;
    }
  }
}
